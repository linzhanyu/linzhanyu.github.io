<!DOCTYPE html>
<html>
<head>
	<meta name="google-site-verification" content="rw2XkgxFpy117mb0QzBkhFwWuv-GCJPlg9yM8YRbzTQ" />
	<meta name="msvalidate.01" content="5EB1F79765AFAE003BBFDD55FB0DCC7F" />
	<meta charset="utf-8">
	<title>Unity3D + tolua 项目中的内存控制</title>
	
	<meta name="author" content="linzhanyu">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- 不蒜子 -->
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
	  (adsbygoogle = window.adsbygoogle || []).push({
	    google_ad_client: "ca-pub-6585202287174868",
	    enable_page_level_ads: true
	  });
	</script>

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link href="/assets/css/myreward.css" rel="stylesheet"  type="text/css">
	<link href="/assets/css/mermaid.css" rel="stylesheet"  type="text/css">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" type="image/png" href="/assets/ico/favicon.png">

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/linzhanyu">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://www.facebook.com/zhanyu.lin.7">
				<i class="fa fa-facebook"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/linzhanyu">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:linzhanyu@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="https://avatars0.githubusercontent.com/u/2173054?v=3&s=35" class="img-circle" />
				林占宇
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="https://avatars0.githubusercontent.com/u/2173054?v=3&s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">林占宇</a>
    </h3>
</header>


<div id="bio" class="text-center">
	<br>Linux, VIM, OpenGL, Unity3D, AI.<br><br>相看莫相笑，同是竹林人。<br><br>
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/linzhanyu">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://www.facebook.com/zhanyu.lin.7">
				<i class="fa fa-facebook fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/linzhanyu">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:linzhanyu@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://pinterest.com/linzhanyu">
				<i class="fa fa-pinterest fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/linzhanyu">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Unity3D + tolua 项目中的内存控制 </h1>
</div>
	
<article>
		
	
		
	<div class="col-sm-10">
	 <span class="post-date">
	   
	   September 
	   6th,
	   
	   2017
	 </span>
	  <div class="article_body">
	  <p>Unity3D 项目如果出现了内存泄漏，这可是个令人头疼的问题。
尤其是 C# + LUA 同时存在的项目</p>

<h2 id="起因">起因</h2>
<p>由于IOS平台无法简单地实现代码层面的功能热更新, 大家想了各种各样的方法来做了不同的方案.
比如早先的 xLua, uLua 虽性能较差但也已经可用.</p>

<p>而后的 LSharp 它最初的想法很好,代码都使用C#语言编写,让IL直接变成脚本解释器的资源,但由于引入了 il2cpp 后这种实现方式出现了问题.后来也没有什么更新了.</p>

<p>这时又有tolua诞生直接使用C形式的Lua接口提高了LUA的运行时性能.LUA语言小巧简单易编写,对从业人员要求低.提供了代码热更新的一种良好的实现方案.</p>

<p>手机游戏中代码需要热更新的部分主要集中于 UI / 网络协议 / 数据表</p>

<h2 id="实际问题">实际问题</h2>
<p>为什么会占用太多的内存呢? 主要原因是由于 C# / Lua 这一类语言的内存释放是基于GC的.而GC又是基于变量的引用计数.那么程序代码中必要要做的事情就是解开相互之间关联的引用.</p>

<p>内存问题主要集中于两个方面:</p>
<h3 id="内存占用太多">内存占用太多</h3>
<ol>
  <li>代码编写不合理功能模块使用了太多的内存</li>
  <li>该释放的部分在工作时间段结束后依然没有明确的释放</li>
</ol>

<h3 id="内存泄露-看起来释放了但其实没有">内存泄露 看起来释放了但其实没有</h3>
<ol>
  <li>比如 GameObject 已经不存在了,但是 Component / Material / Texture 还依然存在, 而且再没有代码可以访问并且释放它们.</li>
</ol>

<h2 id="详述">详述</h2>
<p>Unity 项目中的内存占用主要由 Native Heap, Managed Heap 两部分组成.本地堆和托管堆的主要区别就是是否受C#的内存垃圾收集器自动管理.</p>

<p>代码中大块的对像主要是这么几个部分:</p>
<h4 id="c-部分">C# 部分:</h4>
<p>Asset Bundle			资源包</p>

<p>Asset Resource			资源包里的资源文件</p>

<p>Asset Instantiate		实例化以后的 GameObject 以及上面挂着的各种 Component / Material / Texture</p>

<p><img src="/assets/image/assetbundle.jpg" alt="AssetBundle" /></p>

<h4 id="lua-部分">LUA 部分:</h4>
<p>tolua 的 Lua 是C的, 是不受托管堆管理的,也就是说是在 NativeHeap 中的.但是它的逻辑最终主要是操控某个 GameObject 或者是某个 C# 的 Class Object ,但是 Object 是存在于托管堆中的, 那么也就是说只要 Lua 需要控制, C# 托管堆中的 Object 就得活着. 不能被垃圾回收器自动回收掉.</p>

<p>由于代码写在了Lua中还有一种需要做的事情是C#回调Lua中的函数,比如要在等等用户点击某处的时候进行一个操作 Lua 需要提供一个 Delegate / Action 样的东西给C#层来使用.</p>

<p>C#语言由于没有明显的析构函数,为了使用非托管资源做了一个颇具争议的IDisposeable接口.继承这个接口的对象在不使用的时候要明确的调用以释放非托管资源.</p>

<h3 id="tolua-中有一些关键点">tolua 中有一些关键点:</h3>
<p>C# 给Lua用的对象为了保持它的存活tolua使用了一个 ObjectTranslator 来为它们建立引用以保障不被垃圾回收.
Lua 给C#中使用回调函数之类会集中在 funcRefMap / delegateMap 中.以保持引用数据不被Lua回收</p>

<p>那么只要这些地方的引用计数在维护过程中出现问题就会导致内存资源被持续持有</p>

<h2 id="分析方法">分析方法</h2>
<h3 id="打印c堆内实例">打印C#堆内实例</h3>
<p>使用第三方插件 UnityHeapDump. 由于该代码在输出的过程中会撑大 mono heap 经常在还没有输出完成的时候就发生无法分配内存.即使完成了打印操作,游戏逻辑也会出现一些奇怪的问题,而无法继续.</p>

<p>但是这个插件是可以打印出那些关联的比较大的对象或者某个容器中的东西比较多.</p>

<h3 id="打印lua堆内实例-并做对比">打印Lua堆内实例 并做对比</h3>
<p>使用第三方插件 LuaMemorySnapshotDump. 该代码由Lua书写, 在打印Lua内存的过程中可能会造成Lua无法分配内存的问题.不过不常见.</p>

<h2 id="解决">解决</h2>
<h3 id="1-代码bug">1. 代码BUG</h3>
<blockquote>
  <ol>
    <li>通过观察我们发现C#的 Struct 会在 ObjectTranslator 中产生大量的复制品,如果是每帧会访问多次的Struct建议改为访问Class</li>
    <li>需要在特定的时刻调用 LuaState.RefreshDelegateMap</li>
  </ol>
</blockquote>

<h3 id="2-框架失误">2. 框架失误</h3>
<blockquote>
  <ol>
    <li>在 Delegate 的执行函数中试图从链中删除自己的 Delegate 这是办不到的.</li>
    <li>框架在设计时没有在恰当的时候明确的调用LuaFunction / LuaTable 之类的对象的 Dispose 函数 导致该LUA对象引用的其它的C#对象也不会释放.造成大量的内存泄漏.</li>
    <li>恰当频繁的手动执行LuaGC.</li>
  </ol>
</blockquote>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#unity-ref">
					unity <span>(5)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#tolua-ref">
					tolua <span>(1)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#optimization-ref">
					optimization <span>(6)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#unity-ref">
					unity <span>(5)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#tolua-ref">
					tolua <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#memory-ref">
					memory <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#leak-ref">
					leak <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>


      <div class="reward">
      	<div class="reward-button">赏 <span class="reward-code">
      		<span class="alipay-code"> <img class="alipay-img wdp-appear" src="/assets/image/social/Alipyspeed.png"><b>支付宝打赏</b> </span>
      		<span class="wechat-code"> <img class="wechat-img wdp-appear" src="/assets/image/social/Wechatspeed.png"><b>微信打赏</b> </span> </span>
      	</div>
      	<p class="reward-notice">您的打赏是对我最大的鼓励！</p>
      </div>
		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Unity3D + tolua 项目中的内存控制&via=linzhanyu"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="https://avatars0.githubusercontent.com/u/2173054?v=3&s=35" class="img-rounded author-image" />
        <h4 class="section-title author-name">linzhanyu</h4>
        <p class="author-bio"><br>Linux, VIM, OpenGL, Unity3D, AI.<br><br>相看莫相笑，同是竹林人。<br><br></p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/unity3d/timeline/2017/04/26/unity-timeline.html" title="Unity3D 中的 Timeline 使用">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/python3/vim/2017/11/29/vim-python3.html" title="VIM Python3 自动代码补全">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
	
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'linzhanyu';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





		<footer>
			<hr/>
			<div class="footer-left">
				<p>
					&copy; 2019 linzhanyu with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
				</p>
			</div>
			<div class="footer-right">
				<span id="busuanzi_container_site_uv">
				    本站访客数<span id="busuanzi_value_site_uv"></span>人次
				</span>
			</div>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'linzhanyu']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

